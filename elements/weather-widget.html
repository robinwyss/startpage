<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../bower_components/core-header-panel/core-header-panel.html" />
<link rel="import" href="../bower_components/core-toolbar/core-toolbar.html" />
<link rel="import" href="../bower_components/paper-shadow/paper-shadow.html">
<polymer-element name="weather-widget">
    <template>
        <style>
            :host {
                width: 350px;
                height: 120px;
                display: block;
                font-size: 12px; 
            }
            .condition{
                float: left;
            }
            .icon, .temp  {
                float: right;
            }
            .condition,
            .icon,
            .temp {
                display: inline-block;
                margin: 10px;
                vertical-align: top;
            }
            .forecast {
                overflow: hidden;
            }
            .condition h2 {
                margin: 10px;
            }
            .city {
                font-size: 1.5em;
            }
            .sun {
                text-align: center;
            }
            core-header-panel {
                width: 270px;
                height: 200px;
            }
        </style>
        <core-ajax auto url="http://api.openweathermap.org/data/2.5/weather" params='{"q":"Copenhagen,dk", "units": "metric"}'
        handleAs="json" id="ajax" on-core-response="{{handleResponse}}"></core-ajax>
        <div>
            <div>
                <div class="forecast">
                    <div class="condition">
                        <span class="city">{{city}}</span>
                        <div>{{description}}</div>
                        <div>Wind {{wind}} km/h</div>
                        <div class="sun">Sunrise: {{sunrise}} - Sunset: {{sunset}}</div>
                    </div>
                    <div class="icon">
                        <weather-icon condition="{{icon}}"></weather-icon>
                    </div>
                    <div class="temp">
                        <span>{{temp}}Â°</span>
                    </div>
                </div>
                
            </div>
        </div>
    </template>
    <script>
        Polymer({
            handleResponse: function(event, data) {
                var data = data.response;
                this.city = data.name;
                this.wind = msToKmh(data.wind.speed);
                this.sunrise = getTime(data.sys.sunrise, data.dt);
                this.sunset = getTime(data.sys.sunset, data.dt);
                this.description = data.weather[0].description;
                this.icon = getIcon(data.weather[0].icon);
                this.temp = Math.round(data.main.temp);

                function getIcon(name) {
                    var map = {
                        '01': 'sunny',
                        '02': 'partly-cloudy',
                        '03': 'cloudy',
                        '04': 'heavy-clouds',
                        '09': 'rain',
                        '10': 'rain',
                        '11': 'storm',
                        '13': 'snow',
                        '50': 'mist'
                    };
                    return map[name.substr(0, 2)];
                }

                function getTime(millis, dt) {
                    var date = new Date(millis * 1000)
                    return date.getHours() + ':' + date.getMinutes();
                }

                function msToKmh(ms) {
                    return Math.round(ms * 3.6 * 10) / 10;
                }
            }
        })
    </script>
</polymer-element>